language: python
sudo: false
python:
  - "2.7"

addons:
  - ssh_known_hosts: localhost
  - postgresql: "9.3"

env:
    - TOX_ENV=pep8
    - TOX_ENV=unittests

install:

    - ssh-keygen -f ~/.ssh/id_rsa -y >> ~/.ssh/id_rsa.pub
    - cat ~/.ssh/id_rsa.pub
    - cat ~/.ssh/id_rsa
    - cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys
    - chmod +x ~/.ssh/authorized_keys
    - echo -e "StrictHostKeyChecking no\n" >> ~/.ssh/conf

    - pip install tox
    - pip install https://github.com/cloudify-cosmo/cloudify-rest-client/archive/3.2.zip
    - pip install https://github.com/cloudify-cosmo/cloudify-dsl-parser/archive/3.2.zip
    - pip install https://github.com/cloudify-cosmo/cloudify-plugins-common/archive/3.2.zip
    - pip install https://github.com/cloudify-cosmo/cloudify-script-plugin/archive/1.2.zip
    - pip install https://github.com/cloudify-cosmo/cloudify-cli/archive/3.2.zip
    - pip install https://github.com/cloudify-cosmo/tosca-vcloud-plugin/archive/1.2.zip

before_script:
    - psql -c 'create database score;' -U postgres
    - export SCORE_DB='postgresql://postgres@localhost/score'
    - cfy init

script:
    - tox -c score-api-server/tox.ini -e $TOX_ENV
    - cfy blueprints validate -p blueprints/vcloud-manager-blueprint.yaml
    - cfy blueprints validate -p blueprints/vcloud-manager-blueprint.yaml
    - cfy blueprints validate -p blueprints/vcloud-postgresql-blueprint.yaml
    - cfy blueprints validate -p blueprints/vcloud-score-blueprint.yaml
    - cfy blueprints validate -p blueprints/vcloud-nodecellar-blueprint.yaml
    - cfy blueprints validate -p blueprints/vcloud-manager-blueprint.yaml
    - cfy blueprints validate -p blueprints/vcloud-nodecellar-blueprint-local.yaml
    - cfy blueprints validate -p blueprints/vcloud-nodecellar-blueprint-local-with-fabric.yaml
    - cfy blueprints validate -p blueprints/vcloud-postgresql-blueprint-local-with-fabric.yaml
    - cfy local init --install-plugins -p blueprints/vcloud-nodecellar-blueprint-local.yaml
    - cfy local init --install-plugins -p blueprints/vcloud-nodecellar-blueprint-local-with-fabric.yaml -i blueprints/inputs/inputs.travis-ci.yaml
    - cfy local init --install-plugins -p blueprints/vcloud-postgresql-blueprint-local-with-fabric.yaml -i blueprints/inputs/inputs.travis-ci.yaml
